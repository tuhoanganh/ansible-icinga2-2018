{"version":3,"sources":["../../../../../../../icinga2-report-panel/app/plugins/panel/table/renderer.ts"],"names":["_","moment","kbn","TableRenderer","panel","table","isUtc","sanitize","templateSrv","initColumns","formatters","colorState","colIndex","columns","length","column","title","text","i","styles","style","regex","stringToJsRegex","pattern","match","alias","replace","createColumnFormatter","value","thresholds","colors","first","v","undefined","isArray","join","escape","defaultCellFormatter","type","date","utc","format","dateFormat","valueFormatter","valueFormats","unit","isString","colorMode","getColorForValue","decimals","rowIndex","scopedVars","cell_variable","row","rows","columnIndex","addWidthHack","formatColumnValue","cellClasses","cellClass","cell","columnHtml","hidden","preserveFormat","push","link","renderRowVariables","cellLink","linkUrl","cellLinkTooltip","linkTooltip","cellTarget","linkTargetBlank","filterable","page","pageSize","startPos","endPos","Math","min","html","y","cellHtml","rowStyle","renderCell","new_row"],"mappings":"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","file":"renderer.js","sourcesContent":["import _ from 'lodash';\nimport moment from 'moment';\nimport kbn from 'app/core/utils/kbn';\n\nexport class TableRenderer {\n  formatters: any[];\n  colorState: any;\n\n  constructor(private panel, private table, private isUtc, private sanitize, private templateSrv) {\n    this.panel = panel;\n    this.table = table;\n    this.initColumns();\n  }\n\n  setTable(table) {\n    this.table = table;\n\n    this.initColumns();\n  }\n\n  initColumns() {\n    this.formatters = [];\n    this.colorState = {};\n\n    for (let colIndex = 0; colIndex < this.table.columns.length; colIndex++) {\n      let column = this.table.columns[colIndex];\n      column.title = column.text;\n\n      for (let i = 0; i < this.panel.styles.length; i++) {\n        let style = this.panel.styles[i];\n\n        var regex = kbn.stringToJsRegex(style.pattern);\n        if (column.text.match(regex)) {\n          column.style = style;\n\n          if (style.alias) {\n            column.title = column.text.replace(regex, style.alias);\n          }\n\n          break;\n        }\n      }\n\n      this.formatters[colIndex] = this.createColumnFormatter(column);\n    }\n  }\n\n  getColorForValue(value, style) {\n    if (!style.thresholds) { return null; }\n\n    for (var i = style.thresholds.length; i > 0; i--) {\n      if (value >= style.thresholds[i - 1]) {\n        return style.colors[i];\n      }\n    }\n    return _.first(style.colors);\n  }\n\n  defaultCellFormatter(v, style) {\n    if (v === null || v === void 0 || v === undefined) {\n      return '';\n    }\n\n    if (_.isArray(v)) {\n      v = v.join(', ');\n    }\n\n    if (style && style.sanitize) {\n      return this.sanitize(v);\n    } else {\n      return _.escape(v);\n    }\n  }\n\n  createColumnFormatter(column) {\n    if (!column.style) {\n      return this.defaultCellFormatter;\n    }\n\n    if (column.style.type === 'hidden') {\n      return v => {\n        return undefined;\n      };\n    }\n\n    if (column.style.type === 'date') {\n      return v => {\n        if (v === undefined || v === null) {\n          return '-';\n        }\n\n        if (_.isArray(v)) { v = v[0]; }\n        var date = moment(v);\n        if (this.isUtc) {\n          date = date.utc();\n        }\n        return date.format(column.style.dateFormat);\n      };\n    }\n\n    if (column.style.type === 'number') {\n      let valueFormatter = kbn.valueFormats[column.unit || column.style.unit];\n\n      return v =>  {\n        if (v === null || v === void 0) {\n          return '-';\n        }\n\n        if (_.isString(v) || _.isArray(v)) {\n          return this.defaultCellFormatter(v, column.style);\n        }\n\n        if (column.style.colorMode) {\n          this.colorState[column.style.colorMode] = this.getColorForValue(v, column.style);\n        }\n\n        return valueFormatter(v, column.style.decimals, null);\n      };\n    }\n\n    return (value) => {\n      return this.defaultCellFormatter(value, column.style);\n    };\n  }\n\n  renderRowVariables(rowIndex) {\n    let scopedVars = {};\n    let cell_variable;\n    let row = this.table.rows[rowIndex];\n    for (let i = 0; i < row.length; i++) {\n      cell_variable = `__cell_${i}`;\n      scopedVars[cell_variable] = { value: row[i] };\n    }\n    return scopedVars;\n  }\n\n  formatColumnValue(colIndex, value) {\n    return this.formatters[colIndex] ? this.formatters[colIndex](value) : value;\n  }\n\n  renderCell(columnIndex, rowIndex, value, addWidthHack = false) {\n    value = this.formatColumnValue(columnIndex, value);\n\n    var column = this.table.columns[columnIndex];\n    var style = '';\n    var cellClasses = [];\n    var cellClass = '';\n\n    if (this.colorState.cell) {\n      style = ' style=\"background-color:' + this.colorState.cell + ';color: white\"';\n      this.colorState.cell = null;\n    } else if (this.colorState.value) {\n      style = ' style=\"color:' + this.colorState.value + '\"';\n      this.colorState.value = null;\n    }\n\n    // because of the fixed table headers css only solution\n    // there is an issue if header cell is wider the cell\n    // this hack adds header content to cell (not visible)\n    var columnHtml = '';\n    if (addWidthHack) {\n      columnHtml = '<div class=\"table-panel-width-hack\">' + this.table.columns[columnIndex].title + '</div>';\n    }\n\n    if (value === undefined) {\n      style = ' style=\"display:none;\"';\n      column.hidden = true;\n    } else {\n      column.hidden = false;\n    }\n\n    if (column.style && column.style.preserveFormat) {\n      cellClasses.push(\"table-panel-cell-pre\");\n    }\n\n    if (column.style && column.style.link) {\n      // Render cell as link\n      var scopedVars = this.renderRowVariables(rowIndex);\n      scopedVars['__cell'] = { value: value };\n\n      var cellLink = this.templateSrv.replace(column.style.linkUrl, scopedVars);\n      var cellLinkTooltip = this.templateSrv.replace(column.style.linkTooltip, scopedVars);\n      var cellTarget = column.style.linkTargetBlank ? '_blank' : '';\n\n      cellClasses.push(\"table-panel-cell-link\");\n      columnHtml += `\n        <a href=\"${cellLink}\" target=\"${cellTarget}\" data-link-tooltip data-original-title=\"${cellLinkTooltip}\" data-placement=\"right\">\n          ${value}\n        </a>\n      `;\n    } else {\n      columnHtml += value;\n    }\n\n    if (column.filterable) {\n      cellClasses.push(\"table-panel-cell-filterable\");\n      columnHtml += `\n        <a class=\"table-panel-filter-link\" data-link-tooltip data-original-title=\"Filter out value\" data-placement=\"bottom\"\n           data-row=\"${rowIndex}\" data-column=\"${columnIndex}\" data-operator=\"!=\">\n          <i class=\"fa fa-search-minus\"></i>\n        </a>\n        <a class=\"table-panel-filter-link\" data-link-tooltip data-original-title=\"Filter for value\" data-placement=\"bottom\"\n           data-row=\"${rowIndex}\" data-column=\"${columnIndex}\" data-operator=\"=\">\n          <i class=\"fa fa-search-plus\"></i>\n        </a>`;\n    }\n\n    if (cellClasses.length) {\n      cellClass = ' class=\"' + cellClasses.join(' ') + '\"';\n    }\n\n    columnHtml = '<td' + cellClass + style + '>' + columnHtml + '</td>';\n    return columnHtml;\n  }\n\n  render(page) {\n    let pageSize = this.panel.pageSize || 100;\n    let startPos = page * pageSize;\n    let endPos = Math.min(startPos + pageSize, this.table.rows.length);\n    var html = \"\";\n\n    for (var y = startPos; y < endPos; y++) {\n      let row = this.table.rows[y];\n      let cellHtml = '';\n      let rowStyle = '';\n      for (var i = 0; i < this.table.columns.length; i++) {\n        cellHtml += this.renderCell(i, y, row[i], y === startPos);\n      }\n\n      if (this.colorState.row) {\n        rowStyle = ' style=\"background-color:' + this.colorState.row + ';color: white\"';\n        this.colorState.row = null;\n      }\n\n      html += '<tr ' + rowStyle + '>' + cellHtml + '</tr>';\n    }\n\n    return html;\n  }\n\n  render_values() {\n    let rows = [];\n\n    for (var y = 0; y < this.table.rows.length; y++) {\n      let row = this.table.rows[y];\n      let new_row = [];\n      for (var i = 0; i < this.table.columns.length; i++) {\n        new_row.push(this.formatColumnValue(i, row[i]));\n      }\n      rows.push(new_row);\n    }\n    return {\n        columns: this.table.columns,\n        rows: rows,\n    };\n  }\n}\n"]}