{"version":3,"sources":["../../../../../../../icinga2-report-panel/app/plugins/panel/table/transformers.ts"],"names":["transformDataToTable","data","panel","model","TableModel","length","transformer","transformers","transform","message","_","flatten","TimeSeries","description","getColumns","columns","text","type","i","series","y","datapoints","dp","rows","push","target","points","timeKey","toString","time","point","values","value","alias","getFlotPairs","cells","stats","annotations","evt","title","tags","names","maxDocs","Math","min","doc","flattened","propName","map","key","z","column","tableCol","filterable","isObject","JSON","stringify"],"mappings":"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","file":"transformers.js","sourcesContent":["import _ from 'lodash';\nimport flatten from '../../../core/utils/flatten';\nimport TimeSeries from '../../../core/time_series2';\nimport TableModel from '../../../core/table_model';\n\nvar transformers = {};\n\ntransformers['timeseries_to_rows'] = {\n  description: 'Time series to rows',\n  getColumns: function() {\n    return [];\n  },\n  transform: function(data, panel, model) {\n    model.columns = [\n      {text: 'Time', type: 'date'},\n      {text: 'Metric'},\n      {text: 'Value'},\n    ];\n\n    for (var i = 0; i < data.length; i++) {\n      var series = data[i];\n      for (var y = 0; y < series.datapoints.length; y++) {\n        var dp = series.datapoints[y];\n        model.rows.push([dp[1], series.target, dp[0]]);\n      }\n    }\n  },\n};\n\ntransformers['timeseries_to_columns'] = {\n  description: 'Time series to columns',\n  getColumns: function() {\n    return [];\n  },\n  transform: function(data, panel, model) {\n    model.columns.push({text: 'Time', type: 'date'});\n\n    // group by time\n    var points = {};\n\n    for (let i = 0; i < data.length; i++) {\n      var series = data[i];\n      model.columns.push({text: series.target});\n\n      for (var y = 0; y < series.datapoints.length; y++) {\n        var dp = series.datapoints[y];\n        var timeKey = dp[1].toString();\n\n        if (!points[timeKey]) {\n          points[timeKey] = {time: dp[1]};\n          points[timeKey][i] = dp[0];\n        } else {\n          points[timeKey][i] = dp[0];\n        }\n      }\n    }\n\n    for (var time in points) {\n      var point = points[time];\n      var values = [point.time];\n\n      for (let i = 0; i < data.length; i++) {\n        var value = point[i];\n        values.push(value);\n      }\n\n      model.rows.push(values);\n    }\n  }\n};\n\ntransformers['timeseries_aggregations'] = {\n  description: 'Time series aggregations',\n  getColumns: function() {\n    return [\n      {text: 'Avg', value: 'avg'},\n      {text: 'Min', value: 'min'},\n      {text: 'Max', value: 'max'},\n      {text: 'Total', value: 'total'},\n      {text: 'Current', value: 'current'},\n      {text: 'Count', value: 'count'},\n    ];\n  },\n  transform: function(data, panel, model) {\n    var i, y;\n    model.columns.push({text: 'Metric'});\n\n    for (i = 0; i < panel.columns.length; i++) {\n      model.columns.push({text: panel.columns[i].text});\n    }\n\n    for (i = 0; i < data.length; i++) {\n      var series = new TimeSeries({\n        datapoints: data[i].datapoints,\n        alias: data[i].target,\n      });\n\n      series.getFlotPairs('connected');\n      var cells = [series.alias];\n\n      for (y = 0; y < panel.columns.length; y++) {\n        cells.push(series.stats[panel.columns[y].value]);\n      }\n\n      model.rows.push(cells);\n    }\n  }\n};\n\ntransformers['annotations'] = {\n  description: 'Annotations',\n  getColumns: function() {\n    return [];\n  },\n  transform: function(data, panel, model) {\n    model.columns.push({text: 'Time', type: 'date'});\n    model.columns.push({text: 'Title'});\n    model.columns.push({text: 'Text'});\n    model.columns.push({text: 'Tags'});\n\n    if (!data || !data.annotations || data.annotations.length === 0) {\n      return;\n    }\n\n    for (var i = 0; i < data.annotations.length; i++) {\n      var evt = data.annotations[i];\n      model.rows.push([evt.time, evt.title, evt.text, evt.tags]);\n    }\n  }\n};\n\ntransformers['table'] = {\n  description: 'Table',\n  getColumns: function(data) {\n    if (!data || data.length === 0) {\n      return [];\n    }\n    return data[0].columns;\n  },\n  transform: function(data, panel, model) {\n    if (!data || data.length === 0) {\n      return;\n    }\n\n    if (data[0].type !== 'table') {\n      throw {message: 'Query result is not in table format, try using another transform.'};\n    }\n\n    model.columns = data[0].columns;\n    model.rows = data[0].rows;\n  }\n};\n\ntransformers['json'] = {\n  description: 'JSON Data',\n  getColumns: function(data) {\n    if (!data || data.length === 0) {\n      return [];\n    }\n\n    var names: any = {};\n    for (var i = 0; i < data.length; i++) {\n      var series = data[i];\n      if (series.type !== 'docs') {\n        continue;\n      }\n\n      // only look at 100 docs\n      var maxDocs = Math.min(series.datapoints.length, 100);\n      for (var y = 0; y < maxDocs; y++) {\n        var doc = series.datapoints[y];\n        var flattened = flatten(doc, null);\n        for (var propName in flattened) {\n          names[propName] = true;\n        }\n      }\n    }\n\n    return _.map(names, function(value, key) {\n      return {text: key, value: key};\n    });\n  },\n  transform: function(data, panel, model) {\n    var i, y, z;\n\n    for (let column of panel.columns) {\n      var tableCol: any = {text: column.text};\n\n      // if filterable data then set columns to filterable\n      if (data.length > 0 && data[0].filterable) {\n        tableCol.filterable = true;\n      }\n\n      model.columns.push(tableCol);\n    }\n\n    if (model.columns.length === 0) {\n      model.columns.push({text: 'JSON'});\n    }\n\n    for (i = 0; i < data.length; i++) {\n      var series = data[i];\n\n      for (y = 0; y < series.datapoints.length; y++) {\n        var dp = series.datapoints[y];\n        var values = [];\n\n        if (_.isObject(dp) && panel.columns.length > 0) {\n          var flattened = flatten(dp, null);\n          for (z = 0; z < panel.columns.length; z++) {\n            values.push(flattened[panel.columns[z].value]);\n          }\n        } else {\n          values.push(JSON.stringify(dp));\n        }\n\n        model.rows.push(values);\n      }\n    }\n  }\n};\n\nfunction transformDataToTable(data, panel) {\n  var model = new TableModel();\n\n  if (!data || data.length === 0) {\n    return model;\n  }\n\n  var transformer = transformers[panel.transform];\n  if (!transformer) {\n    throw {message: 'Transformer ' + panel.transform + ' not found'};\n  }\n\n  transformer.transform(data, panel, model);\n  return model;\n}\n\nexport {transformers, transformDataToTable};\n"]}